# 各種センサにおけるRaspiWatchの動作仕様書

## Cdsセルによる室内の明るさに応じたライト制御
RaspiWatchでは、Cdsセルによって室内の明るさを取得し、それに応じたライトの制御を可能にします。  
一定時間人感センサーが反応しない場合、RaspiWatchでは自動的にライトを消灯します。  
ADCがこれまでは実装されていなかったので、カーテンを閉めた状態で消灯しているか、しか判定することができませんでした。（とても暗い部屋以外は、すべてライトが点灯していると判定していました。）  
そのため、日中にカーテンを開けて自然光が入る状態で、ライトを消灯してもRaspiWatchはライトが点灯していると判定してしまい、一定時間経過後に自動的にライトの消灯操作を実施します。  
ライトの消灯操作が固有の信号であればよいのですが、私の家のライトは安物なので、ライトのON/OFF信号が同じです。つまり、このケースではRaspiWatchはライトを消灯しにいっているのに、実際には点灯してしまいます。  
これを解決するためにADCを使用することで、より細かい（0-1024までの数値で）粒度で、部屋の明るさを取得します。
これによって、以下の機能が実現できます。  
- カーテンを開けた状態かつ、ライト消灯で外出しても、RaspiWatchはライトが消灯されていることを把握できる。
ADCを採用していなければ、このケースで外出した場合、一定時間でライトのON/OFF信号が送信されることになります。（全てはライトのON/OFF信号が同じなことが悪いのです。。安物なので。。）
より具体的な仕様は以下になります。  
- 明るさが520以上の場合（とても明るい）、ライトが点灯していると判定する。
- 明るさが401以上、520以下の場合、ライトが消灯していると判定する。（カーテンを開けた状態で、自然光によって少し明るい程度）
- 明るさが400以下の場合、ライトが消灯していると判定する。（カーテンを閉めた状態でライトを消灯しているとても暗い部屋）  
参考程度に、動作確認で取得したCdsセルの明るさ値の目安は以下です。  
- カーテン開かつライト点灯：700以上
- カーテン開かつライト消灯：540程度
- カーテン閉かつライト消灯：60程度
- カーテン閉かつライト点灯：700以上
これにより、実際のライトの点灯状態と、RaspiWatchで持っているライトの点灯状態を一致させることができます。

---

## 人感センサー（AM312）による在室判定とライト自動制御

- AM312人感センサーで人の在室を検知します。
- ライトがONの状態で、人感センサーが一定時間（デフォルトで1時間）反応しない場合、自動的にライトを消灯します。
- ライトがOFFの状態で、人感センサーが人を検知した場合、自動的にライトを点灯します。
- ライトのON/OFF判定はCdsセルの明るさ値と連動しています。
- ライトのON/OFF信号はSwitchBot API経由で送信されます。

---

## 温湿度センサー（DHT22）による室内環境の取得

- DHT22センサーを用いて、室内の温度・湿度を1秒ごとに取得し、画面に表示します。
- センサー取得に失敗した場合は再初期化を行い、安定したデータ取得を目指します。

---

## 天気情報の取得・表示

- 外部API（get_weather.py参照）を利用し、大阪の天気情報を6時間ごとに取得します。
- 天気情報に応じて、画面上のアイコンを自動で切り替えます。

---

## 時計・カレンダー表示

- 現在時刻、日付、曜日をリアルタイムで画面に大きく表示します。
- 曜日や日付は日本語表記に対応しています。

---

## SwitchBot APIによるライト制御

- ライトのON/OFFはSwitchBot APIを利用して赤外線リモコン経由で制御します。
- APIトークン、シークレット、デバイスIDは環境変数または.envファイルから読み込みます。
- ライトのON/OFF信号が同一なため、Cdsセルの明るさ値で実際の状態を判定し、誤動作を防止しています。

---

## UI仕様

- Fletを用いた全画面UIを採用しています。
- 温度・湿度・天気・時刻・日付・ライト状態を大きなアイコンや文字で表示します。
- UIは1秒ごとに更新され、リアルタイムな情報を提供します。